#!/bin/bash
# Development tools installation for dotfiles
# This script runs once on first chezmoi apply

set -e

echo "ğŸ“¦ Installing development tools..."
echo ""

{{- if eq .chezmoi.os "darwin" }}
# macOS installation via Homebrew
if ! command -v brew &> /dev/null; then
    echo "âš ï¸  Homebrew not found. Please install it first:"
    echo "  /bin/bash -c \"\$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)\""
    exit 1
fi

echo "ğŸº Installing via Homebrew..."
echo ""

# Core tools
brew install \
    git \
    git-delta \
    git-absorb \
    difftastic \
    gh \
    lazygit \
    tmux \
    fzf \
    fd \
    zoxide \
    sesh \
    eza \
    bat \
    ripgrep \
    vim \
    curl \
    jq \
    node \
    awscli \
    docker \
    docker-compose

# Shell enhancements
brew install \
    zsh-completions \
    direnv \
    colordiff \
    lesspipe \
    bc \
    vivid

# Version managers
brew install \
    pyenv \
    pyenv-virtualenv \
    jenv \
    nvm

# Build tools
brew tap gdubw/gng
brew install gng  # Gradle/Maven wrapper (provides 'gw' command)

# AI/ML tools
brew install ollama

{{- else if eq .chezmoi.os "linux" }}
# Linux installation
if command -v apt-get &> /dev/null; then
    echo "ğŸ“¦ Installing via apt..."
    sudo apt-get update

    # Core tools
    sudo apt-get install -y \
        git \
        tmux \
        fzf \
        fd-find \
        ripgrep \
        gh \
        vim \
        curl \
        jq \
        docker.io \
        docker-compose

    # AWS CLI (via pip if not available)
    if ! command -v aws &> /dev/null; then
        echo "Installing AWS CLI..."
        curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "/tmp/awscliv2.zip"
        unzip -q /tmp/awscliv2.zip -d /tmp
        sudo /tmp/aws/install
        rm -rf /tmp/aws /tmp/awscliv2.zip
    fi

    # Shell enhancements (if available)
    sudo apt-get install -y \
        direnv \
        colordiff \
        bc \
        zoxide \
        eza \
        bat 2>/dev/null || echo "âš ï¸  Some packages not available via apt"

    # Linux desktop environment (X11/i3/dwm) - optional
    echo ""
    read -p "ğŸ“¦ Install Linux desktop environment tools (i3, irssi, conky, X11 utils)? [y/N] " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        echo "Installing desktop environment tools..."
        sudo apt-get install -y \
            i3 \
            i3status \
            i3lock \
            rofi \
            picom \
            xautolock \
            unclutter \
            irssi \
            conky-all \
            rxvt-unicode \
            xterm \
            ibus \
            ibus-gtk \
            ibus-gtk3 \
            imagemagick \
            libnotify-bin \
            python3-gi \
            python3-dbus \
            gir1.2-notify-0.7 \
            libcanberra-gtk-module 2>/dev/null || echo "âš ï¸  Some desktop packages not available"
        echo "âœ… Desktop environment tools installed"
    else
        echo "â­ï¸  Skipping desktop environment tools"
    fi

    # Version managers
    echo ""
    echo "Installing pyenv..."
    if [ ! -d "$HOME/.pyenv" ]; then
        curl https://pyenv.run | bash
    fi

    # AI/ML tools
    echo ""
    if ! command -v ollama &> /dev/null; then
        echo "Installing Ollama..."
        curl -fsSL https://ollama.com/install.sh | sh
    fi

    # Install Nerd Fonts (Linux)
    echo ""
    echo "ğŸ“¥ Installing Nerd Fonts..."
    FONT_DIR="$HOME/.local/share/fonts"
    mkdir -p "$FONT_DIR"

    # Install MesloLGS NF (for Powerlevel10k)
    if ! fc-list 2>/dev/null | grep -q "MesloLGS NF"; then
        echo "  â†’ Installing MesloLGS NF (recommended for Powerlevel10k)..."
        MESLO_URL="https://github.com/romkatv/powerlevel10k-media/raw/master"
        curl -fsSL -o "$FONT_DIR/MesloLGS NF Regular.ttf" "$MESLO_URL/MesloLGS%20NF%20Regular.ttf"
        curl -fsSL -o "$FONT_DIR/MesloLGS NF Bold.ttf" "$MESLO_URL/MesloLGS%20NF%20Bold.ttf"
        curl -fsSL -o "$FONT_DIR/MesloLGS NF Italic.ttf" "$MESLO_URL/MesloLGS%20NF%20Italic.ttf"
        curl -fsSL -o "$FONT_DIR/MesloLGS NF Bold Italic.ttf" "$MESLO_URL/MesloLGS%20NF%20Bold%20Italic.ttf"
        fc-cache -fv > /dev/null 2>&1
        echo "  âœ… MesloLGS NF installed"
    else
        echo "  âœ… MesloLGS NF already installed"
    fi

    # Install FuraCode NF (for terminals, editors, general use)
    if ! fc-list 2>/dev/null | grep -q "FiraCode.*Nerd"; then
        echo "  â†’ Installing FuraCode NF (for editors and general use)..."
        NERD_FONT_VERSION="v3.3.0"
        FIRACODE_URL="https://github.com/ryanoasis/nerd-fonts/releases/download/${NERD_FONT_VERSION}/FiraCode.zip"

        curl -fsSL -o "/tmp/FiraCode.zip" "$FIRACODE_URL"
        unzip -q -o "/tmp/FiraCode.zip" -d "$FONT_DIR" "*.ttf" "*.otf" 2>/dev/null || true
        rm -f "/tmp/FiraCode.zip"
        fc-cache -fv > /dev/null 2>&1
        echo "  âœ… FuraCode NF installed"
    else
        echo "  âœ… FuraCode NF already installed"
    fi

    echo "âœ… Nerd Fonts installation complete"

    echo ""
    echo "âš ï¸  Some tools need manual installation:"
    [ ! -x "$(command -v sesh)" ] && echo "  â€¢ sesh: https://github.com/joshmedeski/sesh/releases"
    [ ! -x "$(command -v lazygit)" ] && echo "  â€¢ lazygit: https://github.com/jesseduffield/lazygit/releases"
    [ ! -x "$(command -v git-absorb)" ] && echo "  â€¢ git-absorb: https://github.com/tummychow/git-absorb/releases"
    [ ! -x "$(command -v difft)" ] && echo "  â€¢ difftastic: https://github.com/Wilfred/difftastic/releases"
    [ ! -x "$(command -v git-delta)" ] && echo "  â€¢ git-delta: https://github.com/dandavison/delta/releases"
    [ ! -x "$(command -v jenv)" ] && echo "  â€¢ jenv: https://github.com/jenv/jenv"
    [ ! -d "$HOME/.nvm" ] && echo "  â€¢ nvm: https://github.com/nvm-sh/nvm"

elif command -v yum &> /dev/null; then
    echo "ğŸ“¦ Installing via yum..."

    # Install available packages
    sudo yum install -y \
        git \
        tmux \
        fzf \
        fd-find \
        zoxide \
        eza \
        bat \
        ripgrep

    # GitHub CLI
    if ! command -v gh &> /dev/null; then
        sudo yum install -y 'dnf-command(config-manager)'
        sudo yum-config-manager --add-repo https://cli.github.com/packages/rpm/gh-cli.repo
        sudo yum install -y gh
    fi

    echo ""
    echo "âš ï¸  Some tools need manual installation:"
    echo "  â€¢ sesh: https://github.com/joshmedeski/sesh/releases"
    echo "  â€¢ lazygit: https://github.com/jesseduffield/lazygit/releases"
    echo "  â€¢ git-delta: https://github.com/dandavison/delta/releases"
    echo "  â€¢ git-absorb: https://github.com/tummychow/git-absorb/releases"
    echo "  â€¢ difftastic: https://github.com/Wilfred/difftastic/releases"
else
    echo "âš ï¸  Unknown package manager. Install manually:"
    echo ""
    echo "Core tools:"
    echo "  â€¢ git, tmux, fzf, fd, zoxide, sesh, eza, bat, ripgrep"
    echo ""
    echo "Git tools:"
    echo "  â€¢ git-delta: https://github.com/dandavison/delta"
    echo "  â€¢ git-absorb: https://github.com/tummychow/git-absorb"
    echo "  â€¢ difftastic: https://github.com/Wilfred/difftastic"
    echo "  â€¢ gh: https://cli.github.com/"
    exit 1
fi
{{- end }}

# Install TPM (Tmux Plugin Manager)
echo ""
if [ ! -d ~/.tmux/plugins/tpm ]; then
    echo "ğŸ“¥ Installing TPM (Tmux Plugin Manager)..."
    git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
    echo "âœ… TPM installed"
else
    echo "âœ… TPM already installed"
fi

# Install Catppuccin for Tmux (manual installation - recommended over TPM)
echo ""
if [ ! -d ~/.tmux/plugins/catppuccin ]; then
    echo "ğŸ“¥ Installing Catppuccin for Tmux..."
    mkdir -p ~/.tmux/plugins
    git clone -b v2.1.3 https://github.com/catppuccin/tmux.git ~/.tmux/plugins/catppuccin
    echo "âœ… Catppuccin for Tmux installed"
else
    echo "âœ… Catppuccin for Tmux already installed"
fi

# Install Zinit (Zsh Plugin Manager)
echo ""
ZINIT_HOME="${XDG_DATA_HOME:-${HOME}/.local/share}/zinit/zinit.git"
if [ ! -d "$ZINIT_HOME" ]; then
    echo "ğŸ“¥ Installing Zinit (Zsh Plugin Manager)..."
    mkdir -p "$(dirname "$ZINIT_HOME")"
    git clone https://github.com/zdharma-continuum/zinit.git "$ZINIT_HOME"
    echo "âœ… Zinit installed"
else
    echo "âœ… Zinit already installed"
fi

# Install vim-plug (Vim Plugin Manager)
echo ""
if [ ! -f ~/.vim/autoload/plug.vim ]; then
    echo "ğŸ“¥ Installing vim-plug (Vim Plugin Manager)..."
    curl -fLo ~/.vim/autoload/plug.vim --create-dirs \
        https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
    echo "âœ… vim-plug installed"
else
    echo "âœ… vim-plug already installed"
fi

# Install Catppuccin theme for bat
echo ""
BAT_THEME_DIR="$(bat --config-dir)/themes"
if [ ! -f "$BAT_THEME_DIR/Catppuccin Mocha.tmTheme" ]; then
    echo "ğŸ“¥ Installing Catppuccin theme for bat..."
    mkdir -p "$BAT_THEME_DIR"

    curl -fsSL -o "$BAT_THEME_DIR/Catppuccin Mocha.tmTheme" \
        https://raw.githubusercontent.com/catppuccin/bat/main/themes/Catppuccin%20Mocha.tmTheme

    # Rebuild bat cache
    bat cache --build > /dev/null 2>&1

    echo "âœ… Catppuccin theme installed for bat"
else
    echo "âœ… Catppuccin theme already installed for bat"
fi

# Install gh-dash (GitHub CLI Dashboard extension)
echo ""
if command -v gh &> /dev/null; then
    if ! gh extension list 2>/dev/null | grep -q "dlvhdr/gh-dash"; then
        echo "ğŸ“¥ Installing gh-dash (GitHub CLI Dashboard)..."
        gh extension install github.com/dlvhdr/gh-dash
        echo "âœ… gh-dash installed"
    else
        echo "âœ… gh-dash already installed"
    fi
else
    echo "âš ï¸  GitHub CLI (gh) not found, skipping gh-dash installation"
fi

{{- if eq .chezmoi.os "darwin" }}
# Install Catppuccin theme for Terminal.app
echo ""
THEME_DIR="$HOME/.config/terminal-themes"
if [ ! -f "$THEME_DIR/Catppuccin-Mocha.terminal" ]; then
    echo "ğŸ“¥ Installing Catppuccin theme for Terminal.app..."
    mkdir -p "$THEME_DIR"

    # Download all Catppuccin flavors for Terminal.app
    curl -fsSL -o "$THEME_DIR/Catppuccin-Mocha.terminal" \
        https://raw.githubusercontent.com/catppuccin/Terminal.app/main/themes/catppuccin-mocha.terminal
    curl -fsSL -o "$THEME_DIR/Catppuccin-Macchiato.terminal" \
        https://raw.githubusercontent.com/catppuccin/Terminal.app/main/themes/catppuccin-macchiato.terminal
    curl -fsSL -o "$THEME_DIR/Catppuccin-Frappe.terminal" \
        https://raw.githubusercontent.com/catppuccin/Terminal.app/main/themes/catppuccin-frappe.terminal
    curl -fsSL -o "$THEME_DIR/Catppuccin-Latte.terminal" \
        https://raw.githubusercontent.com/catppuccin/Terminal.app/main/themes/catppuccin-latte.terminal

    echo "âœ… Catppuccin themes downloaded to $THEME_DIR"
    echo "   To apply: Terminal.app â†’ Settings â†’ Profiles â†’ Import..."
    echo "   Then select: $THEME_DIR/Catppuccin-Mocha.terminal"
else
    echo "âœ… Catppuccin themes already installed"
fi

# Install Nerd Fonts (macOS)
echo ""
echo "ğŸ“¥ Installing Nerd Fonts via Homebrew..."

# Tap the fonts cask if not already tapped
brew tap homebrew/cask-fonts 2>/dev/null || true

# Install MesloLGS NF (for Powerlevel10k)
if ! ls ~/Library/Fonts/ 2>/dev/null | grep -q "MesloLGS NF"; then
    echo "  â†’ Installing MesloLGS NF (recommended for Powerlevel10k)..."
    brew install --cask font-meslo-lg-nerd-font
    echo "  âœ… MesloLGS NF installed"
else
    echo "  âœ… MesloLGS NF already installed"
fi

# Install FuraCode NF (for gVim, general use)
if ! ls ~/Library/Fonts/ 2>/dev/null | grep -q "Fura.*Code.*Nerd"; then
    echo "  â†’ Installing FuraCode NF (for editors and general use)..."
    brew install --cask font-fira-code-nerd-font
    echo "  âœ… FuraCode NF installed"
else
    echo "  âœ… FuraCode NF already installed"
fi

echo "âœ… Nerd Fonts installation complete"
{{- end }}

# Install Ollama models (optional - ~18GB total)
echo ""
if command -v ollama &> /dev/null; then
    echo "ğŸ“¦ Ollama is installed. Pull AI models? (~18GB total)"
    echo "   â€¢ qwen2.5-coder:14b     - 9.0 GB  - Code generation & completion"
    echo "   â€¢ mistral-nemo:latest   - 7.1 GB  - General purpose LLM"
    echo "   â€¢ starcoder2:3b         - 1.7 GB  - Fast code completion"
    echo "   â€¢ nomic-embed-text      - 274 MB  - Text embeddings"
    read -p "Pull Ollama models? [y/N] " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        echo "ğŸ“¥ Pulling Ollama models (this may take a while)..."

        echo "  â†’ Pulling qwen2.5-coder:14b (9.0 GB)..."
        ollama pull qwen2.5-coder:14b

        echo "  â†’ Pulling mistral-nemo:latest (7.1 GB)..."
        ollama pull mistral-nemo:latest

        echo "  â†’ Pulling starcoder2:3b (1.7 GB)..."
        ollama pull starcoder2:3b

        echo "  â†’ Pulling nomic-embed-text:latest (274 MB)..."
        ollama pull nomic-embed-text:latest

        echo "âœ… Ollama models installed"
        echo ""
        echo "ğŸ“– Usage:"
        echo "  â€¢ ollama run qwen2.5-coder:14b    - Code generation"
        echo "  â€¢ ollama run mistral-nemo         - Chat/general queries"
        echo "  â€¢ ollama run starcoder2:3b        - Fast code completion"
        echo "  â€¢ ollama list                     - List installed models"
    else
        echo "â­ï¸  Skipping Ollama models"
        echo "   To install later: ollama pull <model-name>"
    fi
else
    echo "âš ï¸  Ollama not installed, skipping model installation"
fi

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… Installation complete!"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "ğŸ“‹ Installed tools:"
echo ""
echo "Core:"
echo "  â€¢ git        - Version control"
echo "  â€¢ gh         - GitHub CLI"
echo "  â€¢ vim        - Text editor"
echo "  â€¢ curl       - Data transfer tool"
echo "  â€¢ jq         - JSON processor"
echo "  â€¢ node       - JavaScript runtime (includes npm)"
echo "  â€¢ awscli     - AWS command line interface"
echo "  â€¢ docker     - Container platform"
echo ""
echo "Terminal multiplexing:"
echo "  â€¢ tmux       - Terminal multiplexer"
echo "  â€¢ sesh       - Smart session manager"
echo ""
echo "Navigation & Search:"
echo "  â€¢ fzf        - Fuzzy finder"
echo "  â€¢ fd         - Modern find (fast file/directory search)"
echo "  â€¢ zoxide     - Smart directory jumper"
echo ""
echo "Git tools:"
echo "  â€¢ delta      - Modern diff pager"
echo "  â€¢ git-absorb - Automatic fixup commits"
echo "  â€¢ difftastic - Syntax-aware structural diffs"
echo "  â€¢ lazygit    - Terminal UI for git"
echo "  â€¢ gh         - GitHub CLI"
echo "  â€¢ gh-dash    - GitHub CLI Dashboard extension"
echo ""
echo "CLI tools:"
echo "  â€¢ eza        - Modern ls replacement"
echo "  â€¢ bat        - Modern cat with syntax highlighting"
echo "  â€¢ ripgrep    - Fast search tool (rg)"
echo "  â€¢ direnv     - Directory-specific environments"
echo "  â€¢ colordiff  - Colorized diff output"
echo ""
echo "Shell enhancements:"
echo "  â€¢ zsh-completions - Additional completions"
echo "  â€¢ zinit       - Zsh plugin manager"
echo "  â€¢ lesspipe   - Less input preprocessor"
echo "  â€¢ bc         - Calculator for shell"
echo "  â€¢ vivid      - LS_COLORS generator"
echo ""
echo "Version managers:"
echo "  â€¢ pyenv      - Python version manager"
echo "  â€¢ jenv       - Java version manager"
echo "  â€¢ nvm        - Node version manager"
echo ""
echo "Build tools:"
echo "  â€¢ gng        - Gradle/Maven wrapper (gw command)"
echo ""
echo "AI/ML tools:"
echo "  â€¢ ollama     - Local LLM runtime"
echo ""
echo "Plugin managers:"
echo "  â€¢ tpm        - Tmux plugin manager"
echo "  â€¢ zinit      - Zsh plugin manager"
echo "  â€¢ vim-plug   - Vim plugin manager"
echo ""
echo "Themes:"
echo "  â€¢ catppuccin - Tmux theme (manually installed)"
echo ""
echo "Zsh plugins (via Zinit):"
echo "  â€¢ powerlevel10k - Modern zsh theme"
echo "  â€¢ zsh-autosuggestions - Fish-like suggestions"
echo "  â€¢ zsh-syntax-highlighting - Command validation"
echo ""
echo "ğŸš€ Next steps:"
echo "  1. Start a new shell to load all tools"
{{- if eq .chezmoi.os "darwin" }}
echo "  2. Apply Terminal.app theme:"
echo "     â€¢ Terminal â†’ Settings â†’ Profiles â†’ Import"
echo "     â€¢ Select: ~/.config/terminal-themes/Catppuccin-Mocha.terminal"
echo "     â€¢ Set as default profile"
echo "  3. Start tmux: tmux"
echo "  4. Install tmux plugins: Ctrl+a then Shift+I"
echo "  5. Install vim plugins: vim +PlugInstall +qall"
echo "  6. Session manager: Ctrl+a K"
echo "  7. Lazygit in tmux: Ctrl+a g"
echo "  8. Configure p10k: p10k configure (for zsh)"
{{- else }}
echo "  2. Start tmux: tmux"
echo "  3. Install tmux plugins: Ctrl+a then Shift+I"
echo "  4. Install vim plugins: vim +PlugInstall +qall"
echo "  5. Session manager: Ctrl+a K"
echo "  6. Lazygit in tmux: Ctrl+a g"
echo "  7. Configure p10k: p10k configure (for zsh)"
{{- end }}
echo ""
echo "ğŸ“– Git usage:"
echo "  â€¢ git diff   â†’ delta (automatic)"
echo "  â€¢ git dft    â†’ difftastic (structural)"
echo "  â€¢ git absorb â†’ auto-fixup commits"
echo "  â€¢ git fixup  â†’ interactive fixup"
echo "  â€¢ lazygit    â†’ full TUI (or Ctrl+a g in tmux)"
echo "  â€¢ gh dash    â†’ GitHub dashboard (PRs, issues, notifications)"
echo ""
echo "ğŸ¤– Ollama usage:"
echo "  â€¢ ollama list                  â†’ List installed models"
echo "  â€¢ ollama run qwen2.5-coder:14b â†’ Code generation"
echo "  â€¢ ollama run mistral-nemo      â†’ Chat/general queries"
echo "  â€¢ ollama pull <model>          â†’ Download additional models"
echo ""
